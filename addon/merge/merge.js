'use strict';(function(m){"object"==typeof exports&&"object"==typeof module?m(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],m):m(CodeMirror)})(function(m){function B(a,b){this.mv=a;this.type=b;this.classes="left"==b?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:
{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function w(a){a.diffOutOfDate&&(a.diff=N(a.orig.getValue(),a.edit.getValue()),a.chunks=O(a.diff),a.diffOutOfDate=!1,m.signal(a.edit,"updateDiff",a.diff))}function aa(a){function b(b){C=!0;l=!1;"full"==b&&(a.svg&&D(a.svg),a.copyButtons&&D(a.copyButtons),I(a.edit,k.marked,a.classes),I(a.orig,
g.marked,a.classes),k.from=k.to=g.from=g.to=0);w(a);a.showDifferences&&(P(a.edit,a.diff,k,DIFF_INSERT,a.classes),P(a.orig,a.diff,g,DIFF_DELETE,a.classes));"align"==a.mv.options.connect&&J(a);z(a);null!=a.needsScrollSync&&E(a,a.needsScrollSync);C=!1}function c(b){C||(a.dealigned=!0,f(b))}function f(a){C||l||(clearTimeout(h),!0===a&&(l=!0),h=setTimeout(b,!0===a?20:250))}function d(b,d){a.diffOutOfDate||(a.diffOutOfDate=!0,k.from=k.to=g.from=g.to=0);c(d.text.length-1!=d.to.line-d.from.line)}function e(){a.diffOutOfDate=
!0;b("full")}var k={from:0,to:0,marked:[]},g={from:0,to:0,marked:[]},h,l=!1;a.edit.on("change",d);a.orig.on("change",d);a.edit.on("swapDoc",e);a.orig.on("swapDoc",e);for(var p=["markerAdded","markerCleared","lineWidgetAdded","lineWidgetCleared"],x=0;x<p.length;x++)a.edit.on(p[x],c),a.orig.on(p[x],c);a.edit.on("viewportChange",function(){f(!1)});a.orig.on("viewportChange",function(){f(!1)});b();return b}function ba(a){a.edit.on("scroll",function(){E(a,!0)&&z(a)});a.orig.on("scroll",function(){E(a,
!1)&&z(a)})}function E(a,b){var c,f;if(a.diffOutOfDate)return a.lockScroll&&null==a.needsScrollSync&&(a.needsScrollSync=b),!1;a.needsScrollSync=null;if(!a.lockScroll)return!0;var d,e,k=+new Date;b?(d=a.edit,e=a.orig):(d=a.orig,e=a.edit);if(d.state.scrollSetBy==a&&(d.state.scrollSetAt||0)+250>k)return!1;var g=d.getScrollInfo();if("align"==a.mv.options.connect)l=g.top;else{var h=.5*g.clientHeight,l=g.top+h;c=d.lineAtHeight(l,"local");for(var p=a.chunks,x,m,r,t=0;t<p.length;t++){var n=p[t],u=b?n.editFrom:
n.origFrom,y=b?n.editTo:n.origTo;null==m&&(u>c?(m=n.editFrom,r=n.origFrom):y>c&&(m=n.editTo,r=n.origTo));y<=c?(x=n.editTo,f=n.origTo):u<=c&&(x=n.editFrom,f=n.origFrom)}c={before:x,after:m};f={before:f,after:r};d=Q(d,b?c:f);b=Q(e,b?f:c);var l=b.top-h+(l-d.top)/(d.bot-d.top)*(b.bot-b.top),A;l>g.top&&1>(A=g.top/h)?l=l*A+g.top*(1-A):(b=g.height-g.clientHeight-g.top)<h&&(d=e.getScrollInfo(),d.height-d.clientHeight-l>b&&1>(A=b/h)&&(l=l*A+(d.height-d.clientHeight-b)*(1-A)))}e.scrollTo(g.left,l);e.state.scrollSetAt=
k;e.state.scrollSetBy=a;return!0}function Q(a,b){var c=b.after;null==c&&(c=a.lastLine()+1);return{top:a.heightAtLine(b.before||0,"local"),bot:a.heightAtLine(c,"local")}}function R(a,b,c){(a.lockScroll=b)&&0!=c&&E(a,DIFF_INSERT)&&z(a);a.lockButton.innerHTML=b?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function I(a,b,c){for(var f=0;f<b.length;++f){var d=b[f];if(d instanceof m.TextMarker)d.clear();else if(d.parent)for(var e=a,k=c,g=k.classLocation,h=0;h<g.length;h++)e.removeLineClass(d,g[h],k.chunk),
e.removeLineClass(d,g[h],k.start),e.removeLineClass(d,g[h],k.end)}b.length=0}function P(a,b,c,f,d){var e=a.getViewport();a.operation(function(){c.from==c.to||20<e.from-c.to||20<c.from-e.to?(I(a,c.marked,d),K(a,b,f,c.marked,e.from,e.to,d),c.from=e.from,c.to=e.to):(e.from<c.from&&(K(a,b,f,c.marked,e.from,c.from,d),c.from=e.from),e.to>c.to&&(K(a,b,f,c.marked,c.to,e.to,d),c.to=e.to))})}function L(a,b,c,f,d,e){var k=c.classLocation;b=a.getLineHandle(b);for(var g=0;g<k.length;g++)f&&a.addLineClass(b,k[g],
c.chunk),d&&a.addLineClass(b,k[g],c.start),e&&a.addLineClass(b,k[g],c.end);return b}function K(a,b,c,f,d,e,k){function g(b,c){for(var g=Math.max(d,b),h=Math.min(e,c),l=g;l<h;++l)f.push(L(a,l,k,!0,l==b,l==c-1));b==c&&g==c&&h==c&&(g?f.push(L(a,g-1,k,!1,!1,!0)):f.push(L(a,g,k,!1,!0,!1)))}for(var h=q(0,0),l=q(d,0),p=a.clipPos(q(e-1)),x=c==DIFF_DELETE?k.del:k.insert,m=0,r=!1,t=0;t<b.length;++t){var n=b[t],u=n[0],n=n[1];u==DIFF_EQUAL?(u=h.line+(S(b,t)?0:1),F(h,n),n=h.line+(T(b,t)?1:0),n>u&&(r&&(g(m,u),
r=!1),m=n)):(r=!0,u==c&&(u=F(h,n,!0),h=0<(l.line-h.line||l.ch-h.ch)?l:h,n=0>(p.line-u.line||p.ch-u.ch)?p:u,h.line==n.line&&h.ch==n.ch||f.push(a.markText(h,n,{className:x})),h=u))}r&&g(m,h.line+1)}function z(a){if(a.showDifferences){if(a.svg){D(a.svg);var b=a.gap.offsetWidth;U(a.svg,"width",b,"height",a.gap.offsetHeight)}a.copyButtons&&D(a.copyButtons);for(var c=a.edit.getViewport(),f=a.orig.getViewport(),d=a.mv.wrap.getBoundingClientRect().top,e=d-a.edit.getScrollerElement().getBoundingClientRect().top+
a.edit.getScrollInfo().top,d=d-a.orig.getScrollerElement().getBoundingClientRect().top+a.orig.getScrollInfo().top,k=0;k<a.chunks.length;k++){var g=a.chunks[k];if(g.editFrom<=c.to&&g.editTo>=c.from&&g.origFrom<=f.to&&g.origTo>=f.from){var h=a,l=d,p=e,m=b,q="left"==h.type,r=h.orig.heightAtLine(g.origFrom,"local",!0)-l;if(h.svg){var t=r,n=h.edit.heightAtLine(g.editFrom,"local",!0)-p;if(q)var u=t,t=n,n=u;var l=h.orig.heightAtLine(g.origTo,"local",!0)-l,y=h.edit.heightAtLine(g.editTo,"local",!0)-p;q&&
(u=l,l=y,y=u);q=" C "+m/2+" "+n+" "+m/2+" "+t+" "+(m+2)+" "+t;t=" C "+m/2+" "+l+" "+m/2+" "+y+" -1 "+y;U(h.svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")),"d","M -1 "+n+q+" L "+(m+2)+" "+l+t+" z","class",h.classes.connect)}h.copyButtons&&(m=h.copyButtons.appendChild(v("div","left"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy")),n=h.mv.options.allowEditingOriginals,m.title=n?"Push to left":"Revert chunk",m.chunk=g,m.style.top=(g.origTo>g.origFrom?r:h.edit.heightAtLine(g.editFrom,
"local")-p)+"px",n&&(p=h.edit.heightAtLine(g.editFrom,"local")-p,r=h.copyButtons.appendChild(v("div","right"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse")),r.title="Push to right",r.chunk={editFrom:g.origFrom,editTo:g.origTo,origFrom:g.editFrom,origTo:g.editTo},r.style.top=p+"px","right"==h.type?r.style.left="2px":r.style.right="2px"))}}}}function G(a,b){for(var c=0,f=0,d=0;d<b.length;d++){var e=b[d];if(e.editTo>a&&e.editFrom<=a)return null;if(e.editFrom>a)break;c=e.editTo;f=e.origTo}return f+
(a-c)}function ca(a,b){for(var c=[],f=0;f<a.chunks.length;f++){var d=a.chunks[f];c.push([d.origTo,d.editTo,b?G(d.editTo,b.chunks):null])}if(b)a:for(f=0;f<b.chunks.length;f++){for(var d=b.chunks[f],e=0;e<c.length;e++){var k=c[e][1]-d.editTo;if(0==k)continue a;if(0<k)break}c.splice(e,0,[G(d.editTo,a.chunks),d.editTo,d.origTo])}return c}function J(a,b){if(a.dealigned||b){if(!a.orig.curOp)return a.orig.operation(function(){J(a,b)});a.dealigned=!1;var c=a.mv.left==a?a.mv.right:a.mv.left;c&&(w(c),c.dealigned=
!1);for(var f=ca(a,c),d=a.mv.aligners,e=0;e<d.length;e++)d[e].clear();d.length=0;var k=[a.orig,a.edit],g=[];c&&k.push(c.orig);for(e=0;e<k.length;e++)g.push(k[e].getScrollInfo().top);for(c=0;c<f.length;c++)da(k,f[c],d);for(e=0;e<k.length;e++)k[e].scrollTo(null,g[e])}}function da(a,b,c){for(var f=0,d=[],e=0;e<a.length;e++)if(null!=b[e]){var k=a[e].heightAtLine(b[e],"local");d[e]=k;f=Math.max(f,k)}for(e=0;e<a.length;e++)null!=b[e]&&(k=f-d[e],1<k&&c.push(ea(a[e],b[e],k)))}function ea(a,b,c){var f=!0;
b>a.lastLine()&&(b--,f=!1);var d=document.createElement("div");d.className="CodeMirror-merge-spacer";d.style.height=c+"px";d.style.minWidth="1px";return a.addLineWidget(b,d,{height:c,above:f})}function V(a,b,c,f){if(!a.diffOutOfDate){var d=f.origTo>c.lastLine()?q(f.origFrom-1):q(f.origFrom,0),e=q(f.origTo,0),k=f.editTo>b.lastLine()?q(f.editFrom-1):q(f.editFrom,0);f=q(f.editTo,0);var g=a.mv.options.revertChunk;g?g(a.mv,c,d,e,b,k,f):b.replaceRange(c.getRange(d,e),k,f)}}function W(a){var b=a.lockButton=
v("div",null,"CodeMirror-merge-scrolllock");b.title="Toggle locked scrolling";var c=v("div",[b],"CodeMirror-merge-scrolllock-wrap");m.on(b,"click",function(){R(a,!a.lockScroll)});b=[c];!1!==a.mv.options.revertButtons&&(a.copyButtons=v("div",null,"CodeMirror-merge-copybuttons-"+a.type),m.on(a.copyButtons,"click",function(b){b=b.target||b.srcElement;b.chunk&&("CodeMirror-merge-copy-reverse"==b.className?V(a,a.orig,a.edit,b.chunk):V(a,a.edit,a.orig,b.chunk))}),b.unshift(a.copyButtons));"align"!=a.mv.options.connect&&
((c=document.createElementNS&&document.createElementNS("http://www.w3.org/2000/svg","svg"))&&!c.createSVGRect&&(c=null),(a.svg=c)&&b.push(c));return a.gap=v("div",b,"CodeMirror-merge-gap")}function X(a){return"string"==typeof a?a:a.getValue()}function N(a,b){a=fa.diff_main(a,b);for(b=0;b<a.length;++b){var c=a[b];c[1]?b&&a[b-1][0]==c[0]&&(a.splice(b--,1),a[b][1]+=c[1]):a.splice(b--,1)}return a}function O(a){for(var b=[],c=0,f=0,d=q(0,0),e=q(0,0),k=0;k<a.length;++k){var g=a[k],h=g[0];if(h==DIFF_EQUAL){var l=
S(a,k)?0:1,h=d.line+l,l=e.line+l;F(d,g[1],null,e);var m=T(a,k)?1:0,g=d.line+m,m=e.line+m;g>h&&(k&&b.push({origFrom:f,origTo:l,editFrom:c,editTo:h}),c=g,f=m)}else F(h==DIFF_INSERT?d:e,g[1])}(c<=d.line||f<=e.line)&&b.push({origFrom:f,origTo:e.line+1,editFrom:c,editTo:d.line+1});return b}function T(a,b){if(b==a.length-1)return!0;var c=a[b+1][1];if(1==c.length&&b<a.length-2||10!=c.charCodeAt(0))return!1;if(b==a.length-2)return!0;c=a[b+2][1];return(1<c.length||b==a.length-3)&&10==c.charCodeAt(0)}function S(a,
b){if(0==b)return!0;var c=a[b-1][1];if(10!=c.charCodeAt(c.length-1))return!1;if(1==b)return!0;c=a[b-2][1];return 10==c.charCodeAt(c.length-1)}function ga(a,b,c){function f(){e.clear();a.removeLineClass(b,"wrap","CodeMirror-merge-collapsed-line")}a.addLineClass(b,"wrap","CodeMirror-merge-collapsed-line");var d=document.createElement("span");d.className="CodeMirror-merge-collapsed-widget";d.title="Identical text collapsed. Click to expand.";var e=a.markText(q(b,0),q(c-1),{inclusiveLeft:!0,inclusiveRight:!0,
replacedWith:d,clearOnEnter:!0});m.on(d,"click",f);return{mark:e,clear:f}}function ha(a,b){function c(){for(var a=0;a<f.length;a++)f[a].clear()}for(var f=[],d=0;d<b.length;d++){var e=b[d],e=ga(e.cm,e.line,e.line+a);f.push(e);e.mark.on("clear",c)}return f[0].mark}function Y(a,b,c,f){for(var d=0;d<a.chunks.length;d++)for(var e=a.chunks[d],k=e.editFrom-b;k<e.editTo+b;k++){var g=k+c;0<=g&&g<f.length&&(f[g]=!1)}}function v(a,b,c,f){a=document.createElement(a);c&&(a.className=c);f&&(a.style.cssText=f);
if("string"==typeof b)a.appendChild(document.createTextNode(b));else if(b)for(c=0;c<b.length;++c)a.appendChild(b[c]);return a}function D(a){for(var b=a.childNodes.length;0<b;--b)a.removeChild(a.firstChild)}function U(a){for(var b=1;b<arguments.length;b+=2)a.setAttribute(arguments[b],arguments[b+1])}function M(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function F(a,b,c,f){a=c?q(a.line,a.ch):a;for(c=0;;){var d=b.indexOf("\n",c);if(-1==d)break;++a.line;f&&++f.line;c=d+1}a.ch=
(c?0:a.ch)+(b.length-c);f&&(f.ch=(c?0:f.ch)+(b.length-c));return a}function Z(a,b){var c=null,f=a.state.diffViews,d=a.getCursor().line;if(f)for(var e=0;e<f.length;e++){var k=f[e],g=a==k.orig;w(k);if(0>b)a:{for(var k=k.chunks,h=k.length-1;0<=h;h--){var l=k[h],l=(g?l.origTo:l.editTo)-1;if(l<d){g=l;break a}}g=void 0}else a:{k=k.chunks;for(h=0;h<k.length;h++)if(l=k[h],l=g?l.origFrom:l.editFrom,l>d){g=l;break a}g=void 0}null!=g&&(null==c||(0>b?g>c:g<c))&&(c=g)}if(null!=c)a.setCursor(c,0);else return m.Pass}
var q=m.Pos;B.prototype={constructor:B,init:function(a,b,c){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=m(a,M({value:b,readOnly:!this.mv.options.allowEditingOriginals},M(c)));this.orig.state.diffViews=[this];a=c.chunkClassLocation||"background";"[object Array]"!=Object.prototype.toString.call(a)&&(a=[a]);this.classes.classLocation=a;this.diff=N(X(b),X(c.value));this.chunks=O(this.diff);this.diffOutOfDate=this.dealigned=!1;this.needsScrollSync=
null;this.showDifferences=!1!==c.showDifferences},registerEvents:function(){this.forceUpdate=aa(this);R(this,!0,!1);ba(this)},setShowDifferences:function(a){a=!1!==a;a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var C=!1,H=m.MergeView=function(a,b){if(!(this instanceof H))return new H(a,b);this.options=b;var c=b.origLeft,f=null==b.origRight?b.orig:b.origRight,d=null!=c,e=null!=f,k=1+(d?1:0)+(e?1:0),g=[],h=this.left=null,l=this.right=null,p=this;if(d){var h=this.left=
new B(this,"left"),q=v("div",null,"CodeMirror-merge-pane CodeMirror-merge-left");g.push(q);g.push(W(h))}d=v("div",null,"CodeMirror-merge-pane CodeMirror-merge-editor");g.push(d);if(e){l=this.right=new B(this,"right");g.push(W(l));var w=v("div",null,"CodeMirror-merge-pane CodeMirror-merge-right");g.push(w)}(e?w:d).className+=" CodeMirror-merge-pane-rightmost";g.push(v("div",null,null,"height: 0; clear: both;"));var r=this.wrap=a.appendChild(v("div",g,"CodeMirror-merge CodeMirror-merge-"+k+"pane"));
this.edit=m(d,M(b));h&&h.init(q,c,b);l&&l.init(w,f,b);b.collapseIdentical&&this.editor().operation(function(){var a=b.collapseIdentical;"number"!=typeof a&&(a=2);for(var c=[],d=p.editor(),e=d.firstLine(),f=e,g=d.lastLine();f<=g;f++)c.push(!0);p.left&&Y(p.left,a,e,c);p.right&&Y(p.right,a,e,c);for(f=0;f<c.length;f++)if(c[f]){for(var g=f+e,k=1;f<c.length-1&&c[f+1];f++,k++);if(k>a){var h=[{line:g,cm:d}];p.left&&h.push({line:G(g,p.left.chunks),cm:p.left.orig});p.right&&h.push({line:G(g,p.right.chunks),
cm:p.right.orig});h=ha(k,h);if(p.options.onCollapse)p.options.onCollapse(p,g,k,h)}}});"align"==b.connect&&(this.aligners=[],J(this.left||this.right,!0));h&&h.registerEvents();l&&l.registerEvents();var t=function(){h&&z(h);l&&z(l)};m.on(window,"resize",t);var n=setInterval(function(){for(var a=r.parentNode;a&&a!=document.body;a=a.parentNode);a||(clearInterval(n),m.off(window,"resize",t))},5E3)};H.prototype={constructor:H,editor:function(){return this.edit},rightOriginal:function(){return this.right&&
this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a);this.left&&this.left.setShowDifferences(a)},rightChunks:function(){if(this.right)return w(this.right),this.right.chunks},leftChunks:function(){if(this.left)return w(this.left),this.left.chunks}};var fa=new diff_match_patch;m.commands.goNextDiff=function(a){return Z(a,1)};m.commands.goPrevDiff=function(a){return Z(a,-1)}});
