'use strict';(function(m){"object"==typeof exports&&"object"==typeof module?m(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],m):m(CodeMirror)})(function(m){function D(a,b,c){var d=a.docs[b];d?c(A(a,d)):a.options.getFile?a.options.getFile(b,c):c(null)}function x(a,b,c){for(var d in a.docs){var e=a.docs[d];if(e.doc==b)return e}if(!c)for(c=0;;++c)if(d="[doc"+(c||"")+"]",!a.docs[d]){c=d;break}return a.addDoc(c,b)}function E(a,b){if("string"==typeof b)return a.docs[b];
b instanceof m&&(b=b.getDoc());if(b instanceof m.Doc)return x(a,b)}function O(a,b,c){var d=x(a,b),e=a.cachedArgHints;e&&e.doc==b&&0<=B(e.start,c.to)&&(a.cachedArgHints=null);e=d.changed;null==e&&(d.changed=e={from:c.from.line,to:c.from.line});var g=c.from.line+(c.text.length-1);c.from.line<e.to&&(e.to-=c.to.line-g);g>=e.to&&(e.to=g+1);e.from>c.from.line&&(e.from=c.from.line);b.lineCount()>F&&100<c.to-e.from&&setTimeout(function(){d.changed&&100<d.changed.to-d.changed.from&&G(a,d)},200)}function G(a,
b){a.server.request({files:[{type:"full",name:b.name,text:A(a,b)}]},function(c){c?window.console.error(c):b.changed=null})}function P(a,b,c){a.request(b,{type:"completions",types:!0,docs:!0,urls:!0},function(d,e){if(d)return w(a,b,d);d=[];var g="",f=e.start,k=e.end;'["'==b.getRange(t(f.line,f.ch-2),f)&&'"]'!=b.getRange(k,t(k.line,k.ch+2))&&(g='"]');for(var h=0;h<e.completions.length;++h){var l=e.completions[h],n=Q(l.type);e.guess&&(n+=" "+u+"guess");d.push({text:l.name+g,displayText:l.displayName||
l.name,className:n,data:l})}e={from:f,to:k,list:d};var q=null;m.on(e,"close",function(){y(q)});m.on(e,"update",function(){y(q)});m.on(e,"select",function(p,r){y(q);if(p=a.options.completionTip?a.options.completionTip(p.data):p.data.doc)q=C(r.parentNode.getBoundingClientRect().right+window.pageXOffset,r.getBoundingClientRect().top+window.pageYOffset,p,b),q.className+=" "+u+"hint-doc"});c(e)})}function Q(a){a="?"==a?"unknown":"number"==a||"string"==a||"bool"==a?a:/^fn\(/.test(a)?"fn":/^\[/.test(a)?
"array":"object";return u+"completion "+u+"completion-"+a}function H(a,b,c,d,e){a.request(b,d,function(g,f){if(g)return w(a,b,g);if(a.options.typeTip)g=a.options.typeTip(f);else if(g=v("span",null,v("strong",null,f.type||"not found")),f.doc&&g.appendChild(document.createTextNode(" \u2014 "+f.doc)),f.url){g.appendChild(document.createTextNode(" "));var k=g.appendChild(v("a",null,"[docs]"));k.href=f.url;k.target="_blank"}I(b,g,a);e&&e()},c)}function R(a,b){z(a);if(!b.somethingSelected()){var c=b.getTokenAt(b.getCursor()).state;
c=m.innerMode(b.getMode(),c);if("javascript"==c.mode.name&&(c=c.state.lexical,"call"==c.info)){for(var d,e=c.pos||0,g=b.getOption("tabSize"),f=b.getCursor().line,k=Math.max(0,f-9),h=!1;f>=k;--f){for(var l=b.getLine(f),n=d=0;;){n=l.indexOf("\t",n);if(-1==n)break;d+=g-(n+d)%g-1;n+=1}d=c.column-d;if("("==l.charAt(d)){h=!0;break}}if(h){var q=t(f,d);if((c=a.cachedArgHints)&&c.doc==b.getDoc()&&0==B(q,c.start))return J(a,b,e);a.request(b,{type:"type",preferFunction:!0,end:q},function(p,r){!p&&r.type&&/^fn\(/.test(r.type)&&
(a.cachedArgHints={start:q,type:S(r.type),name:r.exprName||r.name||"fn",guess:r.guess,doc:b.getDoc()},J(a,b,e))})}}}}function J(a,b,c){z(a);var d=a.cachedArgHints,e=d.type;d=v("span",d.guess?u+"fhint-guess":null,v("span",u+"fname",d.name),"(");for(var g=0;g<e.args.length;++g){g&&d.appendChild(document.createTextNode(", "));var f=e.args[g];d.appendChild(v("span",u+"farg"+(g==c?" "+u+"farg-current":""),f.name||"?"));"?"!=f.type&&(d.appendChild(document.createTextNode(":\u00a0")),d.appendChild(v("span",
u+"type",f.type)))}d.appendChild(document.createTextNode(e.rettype?") ->\u00a0":")"));e.rettype&&d.appendChild(v("span",u+"type",e.rettype));c=b.cursorCoords(null,"page");var k=a.activeArgHints=C(c.right+1,c.bottom,d,b);setTimeout(function(){k.clear=K(b,function(){a.activeArgHints==k&&z(a)})},20)}function S(a){function b(g){for(var f=0,k=d;;){var h=a.charAt(d);if(g.test(h)&&!f)return a.slice(k,d);/[{\[\(]/.test(h)?++f:/[}\]\)]/.test(h)&&--f;++d}}var c=[],d=3;if(")"!=a.charAt(d))for(;;){var e=a.slice(d).match(/^([^, \(\[\{]+): /);
e&&(d+=e[0].length,e=e[1]);c.push({name:e,type:b(/[\),]/)});if(")"==a.charAt(d))break;d+=2}e=a.slice(d).match(/^\) -> (.*)$/);return{args:c,rettype:e&&e[1]}}function T(a,b){function c(d){d={type:"definition",variable:d||null};var e=x(a,b.getDoc());a.server.request(L(a,e,d),function(g,f){if(g)return w(a,b,g);if(!f.file&&f.url)window.open(f.url);else{if(f.file){g=a.docs[f.file];var k;if(k=g){var h=g.doc;var l=f.context.slice(0,f.contextOffset).split("\n");var n=f.start.line-(l.length-1);k=t(n,(1==l.length?
f.start.ch:h.getLine(n).length)-l[0].length);var q=h.getLine(n).slice(k.ch);for(n+=1;n<h.lineCount()&&q.length<f.context.length;++n)q+="\n"+h.getLine(n);if(q.slice(0,f.context.length)==f.context)var p=f;else{h=h.getSearchCursor(f.context,0,!1);for(q=Infinity;h.findNext();){n=h.from();var r=1E4*Math.abs(n.line-k.line);r||(r=Math.abs(n.ch-k.ch));r<q&&(p=n,q=r)}p?(1==l.length?p.ch+=l[0].length:p=t(p.line+(l.length-1),l[l.length-1].length),f=f.start.line==f.end.line?t(p.line,p.ch+(f.end.ch-f.start.ch)):
t(p.line+(f.end.line-f.start.line),f.end.ch),p={start:p,end:f}):p=null}k=l=p}if(k){a.jumpStack.push({file:e.name,start:b.getCursor("from"),end:b.getCursor("to")});M(a,e,g,l.start,l.end);return}}w(a,b,"Could not find a definition.")}})}U(b)?c():N(b,"Jump to variable",function(d){d&&c(d)})}function M(a,b,c,d,e){c.doc.setSelection(d,e);b!=c&&a.options.switchToDoc&&(z(a),a.options.switchToDoc(c.name,c.doc))}function U(a){var b=a.getCursor("end"),c=a.getTokenAt(b);return c.start<b.ch&&"comment"==c.type?
!1:/[\w)\]]/.test(a.getLine(b.line).slice(Math.max(b.ch-1,0),b.ch+1))}function V(a,b){var c=b.getTokenAt(b.getCursor());if(!/\w/.test(c.string))return w(a,b,"Not at a variable");N(b,"New name for "+c.string,function(d){a.request(b,{type:"rename",newName:d,fullDocs:!0},function(e,g){if(e)return w(a,b,e);W(a,g.changes)})})}function X(a,b){var c=x(a,b.doc).name;a.request(b,{type:"refs"},function(d,e){if(d)return w(a,b,d);d=[];for(var g=0,f=b.getCursor(),k=0;k<e.refs.length;k++){var h=e.refs[k];h.file==
c&&(d.push({anchor:h.start,head:h.end}),0<=B(f,h.start)&&0>=B(f,h.end)&&(g=d.length-1))}b.setSelections(d,g)})}function W(a,b){for(var c=Object.create(null),d=0;d<b.length;++d){var e=b[d];(c[e.file]||(c[e.file]=[])).push(e)}for(var g in c){b=a.docs[g];var f=c[g];if(b){f.sort(function(h,l){return B(l.start,h.start)});var k="*rename"+ ++Y;for(d=0;d<f.length;++d)e=f[d],b.doc.replaceRange(e.text,e.start,e.end,k)}}}function L(a,b,c,d){var e=[],g;(g=!c.fullDocs)||delete c.fullDocs;"string"==typeof c&&(c=
{type:c});c.lineCharPositions=!0;null==c.end&&(c.end=d||b.doc.getCursor("end"),b.doc.somethingSelected()&&(c.start=b.doc.getCursor("start")));d=c.start||c.end;b.changed?b.doc.lineCount()>F&&!1!==g&&100>b.changed.to-b.changed.from&&b.changed.from<=d.line&&b.changed.to>c.end.line?(e.push(Z(b,d,c.end)),c.file="#0",g=e[0].offsetLines,null!=c.start&&(c.start=t(c.start.line- -g,c.start.ch)),c.end=t(c.end.line-g,c.end.ch)):(e.push({type:"full",name:b.name,text:A(a,b)}),c.file=b.name,b.changed=null):c.file=
b.name;for(var f in a.docs)g=a.docs[f],g.changed&&g!=b&&(e.push({type:"full",name:g.name,text:A(a,g)}),g.changed=null);return{query:c,files:e}}function Z(a,b,c){for(var d=a.doc,e=null,g=null,f=b.line-1,k=Math.max(0,f-50);f>=k;--f){var h=d.getLine(f);0>h.search(/\bfunction\b/)||(h=m.countColumn(h,null,4),null!=e&&e<=h||(e=h,g=f))}null==g&&(g=k);f=Math.min(d.lastLine(),c.line+20);if(null==e||e==m.countColumn(d.getLine(b.line),null,4))b=f;else for(b=c.line+1;b<f&&!(h=m.countColumn(d.getLine(b),null,
4),h<=e);++b);e=t(g,0);return{type:"part",name:a.name,offsetLines:e.line,text:d.getRange(e,t(b,c.line==b?null:0))}}function v(a,b){var c=document.createElement(a);b&&(c.className=b);for(var d=2;d<arguments.length;++d){var e=arguments[d];"string"==typeof e&&(e=document.createTextNode(e));c.appendChild(e)}return c}function N(a,b,c){a.openDialog?a.openDialog(b+": <input type=text>",c):c(prompt(b,""))}function I(a,b,c){function d(){a.state.ternTooltip=null;g.parentNode&&aa(g);h()}a.state.ternTooltip&&
y(a.state.ternTooltip);var e=a.cursorCoords(),g=a.state.ternTooltip=C(e.right+1,e.bottom,b,a),f=!1,k=!1;m.on(g,"mousemove",function(){f=!0});m.on(g,"mouseout",function(l){(l=l.relatedTarget||l.toElement)&&m.contains(g,l)||(k?d():f=!1)});setTimeout(function(){k=!0;f||d()},c.options.hintDelay?c.options.hintDelay:1700);var h=K(a,d)}function K(a,b){a.on("cursorActivity",b);a.on("blur",b);a.on("scroll",b);a.on("setDoc",b);return function(){a.off("cursorActivity",b);a.off("blur",b);a.off("scroll",b);a.off("setDoc",
b)}}function C(a,b,c,d){c=v("div",u+"tooltip",c);c.style.left=a+"px";c.style.top=b+"px";(((d.options||{}).hintOptions||{}).container||document.body).appendChild(c);return c}function y(a){var b=a&&a.parentNode;b&&b.removeChild(a)}function aa(a){a.style.opacity="0";setTimeout(function(){y(a)},1100)}function w(a,b,c){a.options.showError?a.options.showError(b,c):I(b,String(c),a)}function z(a){a.activeArgHints&&(a.activeArgHints.clear&&a.activeArgHints.clear(),y(a.activeArgHints),a.activeArgHints=null)}
function A(a,b){var c=b.doc.getValue();a.options.fileFilter&&(c=a.options.fileFilter(c,b.name,b.doc));return c}function ba(a){function b(g,f){f&&(g.id=++d,e[d]=f);c.postMessage(g)}var c=a.worker=new Worker(a.options.workerScript);c.postMessage({type:"init",defs:a.options.defs,plugins:a.options.plugins,scripts:a.options.workerDeps});var d=0,e={};c.onmessage=function(g){var f=g.data;"getFile"==f.type?D(a,f.name,function(k,h){b({type:"getFile",err:String(k),text:h,id:f.id})}):"debug"==f.type?window.console.log(f.message):
f.id&&e[f.id]&&(e[f.id](f.err,f.body),delete e[f.id])};c.onerror=function(g){for(var f in e)e[f](g);e={}};this.addFile=function(g,f){b({type:"add",name:g,text:f})};this.delFile=function(g){b({type:"del",name:g})};this.request=function(g,f){b({type:"req",body:g},f)}}m.TernServer=function(a){var b=this;this.options=a||{};a=this.options.plugins||(this.options.plugins={});a.doc_comment||(a.doc_comment=!0);this.docs=Object.create(null);this.server=this.options.useWorker?new ba(this):new tern.Server({getFile:function(c,
d){return D(b,c,d)},async:!0,defs:this.options.defs||[],plugins:a});this.trackChange=function(c,d){O(b,c,d)};this.activeArgHints=this.cachedArgHints=null;this.jumpStack=[];this.getHint=function(c,d){return P(b,c,d)};this.getHint.async=!0};m.TernServer.prototype={addDoc:function(a,b){var c={doc:b,name:a,changed:null};this.server.addFile(a,A(this,c));m.on(b,"change",this.trackChange);return this.docs[a]=c},delDoc:function(a){if(a=E(this,a))m.off(a.doc,"change",this.trackChange),delete this.docs[a.name],
this.server.delFile(a.name)},hideDoc:function(a){z(this);(a=E(this,a))&&a.changed&&G(this,a)},complete:function(a){a.showHint({hint:this.getHint})},showType:function(a,b,c){H(this,a,b,"type",c)},showDocs:function(a,b,c){H(this,a,b,"documentation",c)},updateArgHints:function(a){R(this,a)},jumpToDef:function(a){T(this,a)},jumpBack:function(a){var b=this.jumpStack.pop(),c=b&&this.docs[b.file];c&&M(this,x(this,a.getDoc()),c,b.start,b.end)},rename:function(a){V(this,a)},selectName:function(a){X(this,a)},
request:function(a,b,c,d){var e=this,g=x(this,a.getDoc()),f=L(this,g,b,d);if(a=f.query&&this.options.queryOptions&&this.options.queryOptions[f.query.type])for(var k in a)f.query[k]=a[k];this.server.request(f,function(h,l){!h&&e.options.responseFilter&&(l=e.options.responseFilter(g,b,f,h,l));c(h,l)})},destroy:function(){z(this);this.worker&&(this.worker.terminate(),this.worker=null)}};var t=m.Pos,u="CodeMirror-Tern-",F=250,Y=0,B=m.cmpPos});
