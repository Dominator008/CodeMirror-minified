'use strict';(function(g){"object"==typeof exports&&"object"==typeof module?g(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],g):g(CodeMirror)})(function(g){function v(a){if(a.getOption("disableInput"))return g.Pass;for(var d=a.listSelections(),c=[],e=a.getOption("autoCloseTags"),k=0;k<d.length;k++){if(!d[k].empty())return g.Pass;var f=d[k].head,b=a.getTokenAt(f),m=g.innerMode(a.getMode(),b.state),
n=m.state,h=m.mode.xmlCurrentTag&&m.mode.xmlCurrentTag(n),l=h&&h.name;if(!l)return g.Pass;var p="html"==m.mode.configuration,q="object"==typeof e&&e.dontCloseTags||p&&w;p="object"==typeof e&&e.indentTags||p&&x;b.end>f.ch&&(l=l.slice(0,l.length-b.end+f.ch));var t=l.toLowerCase();if(!l||"string"==b.type&&(b.end!=f.ch||!/["']/.test(b.string.charAt(b.string.length-1))||1==b.string.length)||"tag"==b.type&&h.close||b.string.indexOf("/")==b.string.length-1||q&&-1<r(q,t)||u(a,m.mode.xmlCurrentContext&&m.mode.xmlCurrentContext(n)||
[],l,f,!0))return g.Pass;(b="object"==typeof e&&e.emptyTags)&&-1<r(b,l)?c[k]={text:"/>",newPos:g.Pos(f.line,f.ch+2)}:(b=p&&-1<r(p,t),c[k]={indent:b,text:">"+(b?"\n\n":"")+"</"+l+">",newPos:b?g.Pos(f.line+1,0):g.Pos(f.line,f.ch+1)})}e="object"==typeof e&&e.dontIndentOnAutoClose;for(k=d.length-1;0<=k;k--)f=c[k],a.replaceRange(f.text,d[k].head,d[k].anchor,"+insert"),l=a.listSelections().slice(0),l[k]={head:f.newPos,anchor:f.newPos},a.setSelections(l),!e&&f.indent&&(a.indentLine(f.newPos.line,null,!0),
a.indentLine(f.newPos.line+1,null,!0))}function q(a,d){var c=a.listSelections(),e=[],k=d?"/":"</",f=a.getOption("autoCloseTags");f="object"==typeof f&&f.dontIndentOnSlash;for(var b=0;b<c.length;b++){if(!c[b].empty())return g.Pass;var m=c[b].head,n=a.getTokenAt(m),h=g.innerMode(a.getMode(),n.state),l=h.state;if(d&&("string"==n.type||"<"!=n.string.charAt(0)||n.start!=m.ch-1))return g.Pass;var p="xml"!=h.mode.name&&"htmlmixed"==a.getMode().name;if(p&&"javascript"==h.mode.name)h=k+"script";else if(p&&
"css"==h.mode.name)h=k+"style";else{h=h.mode.xmlCurrentContext&&h.mode.xmlCurrentContext(l);if(!h||h.length&&u(a,h,h[h.length-1],m))return g.Pass;h=k+h[h.length-1]}">"!=a.getLine(m.line).charAt(n.end)&&(h+=">");e[b]=h}a.replaceSelections(e);c=a.listSelections();if(!f)for(b=0;b<c.length;b++)(b==c.length-1||c[b].head.line<c[b+1].head.line)&&a.indentLine(c[b].head.line)}function r(a,d){if(a.indexOf)return a.indexOf(d);for(var c=0,e=a.length;c<e;++c)if(a[c]==d)return c;return-1}function u(a,d,c,e,k){if(!g.scanForClosingTag)return!1;
var f=Math.min(a.lastLine()+1,e.line+500);e=g.scanForClosingTag(a,e,null,f);if(!e||e.tag!=c)return!1;k=k?1:0;for(var b=d.length-1;0<=b;b--)if(d[b]==c)++k;else break;e=e.to;for(b=1;b<k;b++){d=g.scanForClosingTag(a,e,null,f);if(!d||d.tag!=c)return!1;e=d.to}return!0}g.defineOption("autoCloseTags",!1,function(a,d,c){c!=g.Init&&c&&a.removeKeyMap("autoCloseTags");if(d){c={name:"autoCloseTags"};if("object"!=typeof d||d.whenClosing)c["'/'"]=function(a){a=a.getOption("disableInput")?g.Pass:q(a,!0);return a};
if("object"!=typeof d||d.whenOpening)c["'>'"]=function(a){return v(a)};a.addKeyMap(c)}});var w="area base br col command embed hr img input keygen link meta param source track wbr".split(" "),x="applet blockquote body button div dl fieldset form frameset h1 h2 h3 h4 h5 h6 head html iframe layer legend object ol p select table ul".split(" ");g.commands.closeTag=function(a){return q(a)}});
